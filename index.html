<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyStudio Pro - Python Development Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-orange);
            animation: pulse 2s infinite;
        }

        .status-dot.ready {
            background: var(--accent-green);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Tabs */
        .tabs-container {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            width: 220px;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tab-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
            border-left: 3px solid var(--accent-blue);
        }

        .tab-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .tab-divider {
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
        }

        .tab-section-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 16px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Editor Section */
        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-toolbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-green);
            color: #000;
        }

        .btn-primary:hover {
            background: #2ea043;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-danger:hover {
            background: #da3633;
        }

        .editor-wrapper {
            flex: 1;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100% !important;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
        }

        /* Console */
        .console-section {
            height: 200px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .console-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .console-tabs {
            display: flex;
            gap: 4px;
        }

        .console-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        .console-tab.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .console-line {
            margin-bottom: 4px;
        }

        .console-line.error {
            color: var(--accent-red);
        }

        .console-line.success {
            color: var(--accent-green);
        }

        .console-line.info {
            color: var(--accent-blue);
        }

        .console-line.warning {
            color: var(--accent-orange);
        }

        /* File Manager */
        .file-manager {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
        }

        .file-manager-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .file-manager-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 80px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
        }

        .file-item-remove {
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .file-item-remove:hover {
            color: var(--accent-red);
        }

        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            transition: all 0.2s;
            cursor: pointer;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.1);
        }

        .drop-zone-text {
            font-size: 13px;
        }

        /* AI Chat */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            max-width: 85%;
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message.assistant .chat-avatar {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        .chat-message.user .chat-avatar {
            background: var(--accent-green);
            color: #000;
        }

        .chat-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
        }

        .chat-message.assistant .chat-bubble {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top-left-radius: 4px;
        }

        .chat-message.user .chat-bubble {
            background: var(--accent-blue);
            color: #000;
            border-top-right-radius: 4px;
        }

        .chat-bubble pre {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
        }

        .chat-bubble code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
        }

        .chat-input-container {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            min-height: 48px;
            max-height: 150px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .chat-send-btn {
            background: var(--accent-blue);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-send-btn:hover {
            background: #79b8ff;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Game Canvas */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--bg-primary);
        }

        #gameCanvas {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: #000;
        }

        /* Resizer */
        .resizer {
            height: 4px;
            background: var(--border-color);
            cursor: ns-resize;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: var(--accent-blue);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 17, 23, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading-progress {
            margin-top: 12px;
            width: 200px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s;
        }

        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs-container {
                width: 60px;
            }
            
            .tab-btn span:not(.tab-icon) {
                display: none;
            }
            
            .tab-section-label {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Initializing Python Runtime...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgress"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">Py</div>
            <span class="logo-text">PyStudio Pro</span>
        </div>
        <div class="header-status">
            <div class="status-indicator">
                <div class="status-dot" id="pythonStatus"></div>
                <span id="pythonStatusText">Loading Python...</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Tabs -->
        <nav class="tabs-container">
            <div class="tab-section-label">Editors</div>
            <button class="tab-btn active" data-tab="python">
                <span class="tab-icon">üêç</span>
                <span>Python</span>
            </button>
            <button class="tab-btn" data-tab="pygame">
                <span class="tab-icon">üéÆ</span>
                <span>Pygame Zero</span>
            </button>
            
            <div class="tab-divider"></div>
            
            <div class="tab-section-label">Tools</div>
            <button class="tab-btn" data-tab="chat">
                <span class="tab-icon">ü§ñ</span>
                <span>AI Assistant</span>
            </button>
        </nav>

        <!-- Content Area -->
        <main class="content-area">
            <!-- Python Tab -->
            <div class="tab-content active" id="python-tab">
                <div class="editor-section">
                    <div class="editor-toolbar">
                        <div class="toolbar-left">
                            <span style="font-size: 13px; color: var(--text-secondary);">main.py</span>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary" onclick="clearConsole()">
                                <span>üóëÔ∏è</span> Clear
                            </button>
                            <button class="btn btn-primary" onclick="runPythonCode()">
                                <span>‚ñ∂</span> Run
                            </button>
                        </div>
                    </div>
                    <div class="editor-wrapper">
                        <textarea id="pythonEditor"></textarea>
                    </div>
                </div>
                <div class="resizer" id="pythonResizer"></div>
                <div class="console-section" id="pythonConsole">
                    <div class="console-header">
                        <div class="console-tabs">
                            <button class="console-tab active">Console</button>
                        </div>
                        <span style="font-size: 12px; color: var(--text-secondary);">Output</span>
                    </div>
                    <div class="console-output" id="pythonOutput">
                        <div class="console-line info">Python environment ready. Click "Run" to execute your code.</div>
                    </div>
                </div>
            </div>

            <!-- Pygame Tab -->
            <div class="tab-content" id="pygame-tab">
                <div class="editor-section">
                    <div class="file-manager">
                        <div class="file-manager-header">
                            <span class="file-manager-title">üìÅ Assets</span>
                            <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                                <span>üìé</span> Import Files
                            </button>
                            <input type="file" id="fileInput" multiple accept="image/*,audio/*" style="display: none;" onchange="handleFileImport(event)">
                        </div>
                        <div class="drop-zone" id="dropZone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="drop-zone-text">Drop images or audio files here, or click "Import Files"</div>
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>
                    <div class="editor-toolbar">
                        <div class="toolbar-left">
                            <span style="font-size: 13px; color: var(--text-secondary);">game.py</span>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary" onclick="clearPygameConsole()">
                                <span>üóëÔ∏è</span> Clear
                            </button>
                            <button class="btn btn-danger" onclick="stopGame()" id="stopGameBtn" style="display: none;">
                                <span>‚èπ</span> Stop
                            </button>
                            <button class="btn btn-primary" onclick="runPygameCode()">
                                <span>‚ñ∂</span> Run Game
                            </button>
                        </div>
                    </div>
                    <div class="editor-wrapper">
                        <textarea id="pygameEditor"></textarea>
                    </div>
                </div>
                <div class="resizer" id="pygameResizer"></div>
                <div class="console-section" id="pygameConsole">
                    <div class="console-header">
                        <div class="console-tabs">
                            <button class="console-tab active">Console</button>
                        </div>
                        <span style="font-size: 12px; color: var(--text-secondary);">Game Output</span>
                    </div>
                    <div class="console-output" id="pygameOutput">
                        <div class="console-line info">Pygame Zero environment ready. Import assets and click "Run Game" to start.</div>
                    </div>
                </div>
            </div>

            <!-- AI Chat Tab -->
            <div class="tab-content" id="chat-tab">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message assistant">
                            <div class="chat-avatar">AI</div>
                            <div class="chat-bubble">
                                <strong>Welcome to PyStudio Pro AI Assistant! üëã</strong><br><br>
                                I'm here to help you with:
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li>Python programming questions</li>
                                    <li>Pygame & Pygame Zero game development</li>
                                    <li>Debugging and error fixing</li>
                                    <li>Code optimization and best practices</li>
                                    <li>Algorithm explanations</li>
                                </ul>
                                Feel free to ask me anything about your code!
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" placeholder="Ask me anything about Python, Pygame, or programming..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
                            <button class="chat-send-btn" id="sendBtn" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    
    <script>
        // ========== Global Variables ==========
        let pyodide = null;
        let pythonEditor = null;
        let pygameEditor = null;
        let importedFiles = {};
        let gameRunning = false;
        const GEMINI_API_KEY = 'AIzaSyBhJNUxbHHVih8mukT79OvETExbY3_j9rM';

        // ========== Initialize Application ==========
        async function initializeApp() {
            // Initialize CodeMirror editors
            initializeEditors();
            
            // Initialize tab switching
            initializeTabs();
            
            // Initialize resizers
            initializeResizers();
            
            // Load Pyodide
            await loadPyodide();
        }

        function initializeEditors() {
            // Python Editor
            pythonEditor = CodeMirror.fromTextArea(document.getElementById('pythonEditor'), {
                mode: 'python',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: true,
                matchBrackets: true,
                autoCloseBrackets: true
            });

            pythonEditor.setValue(`# Welcome to PyStudio Pro - Python Editor
# Write your Python code here and click "Run" to execute

import math
import random
import json
from datetime import datetime

def greet(name):
    """A simple greeting function"""
    return f"Hello, {name}! Welcome to PyStudio Pro!"

def calculate_factorial(n):
    """Calculate factorial recursively"""
    if n <= 1:
        return 1
    return n * calculate_factorial(n - 1)

def generate_fibonacci(count):
    """Generate Fibonacci sequence"""
    fib = [0, 1]
    for i in range(2, count):
        fib.append(fib[i-1] + fib[i-2])
    return fib[:count]

# Main execution
if __name__ == "__main__":
    print(greet("Developer"))
    print()
    
    # Factorial example
    num = 5
    print(f"Factorial of {num}: {calculate_factorial(num)}")
    print()
    
    # Fibonacci example
    print(f"First 10 Fibonacci numbers: {generate_fibonacci(10)}")
    print()
    
    # Random number generation
    print(f"Random number between 1-100: {random.randint(1, 100)}")
    print()
    
    # Current time
    print(f"Current time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
`);

            // Pygame Editor
            pygameEditor = CodeMirror.fromTextArea(document.getElementById('pygameEditor'), {
                mode: 'python',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: true,
                matchBrackets: true,
                autoCloseBrackets: true
            });

            pygameEditor.setValue(`# Pygame Zero Example - Bouncing Ball
# Import your images and run the game!

# Game settings
WIDTH = 800
HEIGHT = 600
TITLE = "Bouncing Ball Game"

# Ball properties
ball = {
    'x': 400,
    'y': 300,
    'vx': 5,
    'vy': 3,
    'radius': 20,
    'color': (66, 135, 245)
}

# Paddle properties (controlled with arrow keys)
paddle = {
    'x': 350,
    'y': 550,
    'width': 100,
    'height': 15,
    'speed': 8,
    'color': (76, 175, 80)
}

score = 0

def draw():
    """Draw all game objects"""
    screen.fill((13, 17, 23))
    
    # Draw ball
    screen.draw.filled_circle(
        (ball['x'], ball['y']), 
        ball['radius'], 
        ball['color']
    )
    
    # Draw paddle
    screen.draw.filled_rect(
        Rect(paddle['x'], paddle['y'], paddle['width'], paddle['height']),
        paddle['color']
    )
    
    # Draw score
    screen.draw.text(f"Score: {score}", (20, 20), fontsize=30, color="white")
    
    # Draw instructions
    screen.draw.text(
        "Use LEFT/RIGHT arrow keys to move paddle", 
        (WIDTH // 2, HEIGHT - 30), 
        fontsize=20, 
        color="gray",
        center=True
    )

def update():
    """Update game state"""
    global score
    
    # Move ball
    ball['x'] += ball['vx']
    ball['y'] += ball['vy']
    
    # Ball collision with walls
    if ball['x'] <= ball['radius'] or ball['x'] >= WIDTH - ball['radius']:
        ball['vx'] = -ball['vx']
    
    if ball['y'] <= ball['radius']:
        ball['vy'] = -ball['vy']
    
    # Ball collision with paddle
    if (ball['y'] + ball['radius'] >= paddle['y'] and
        ball['x'] >= paddle['x'] and 
        ball['x'] <= paddle['x'] + paddle['width']):
        ball['vy'] = -abs(ball['vy'])
        score += 10
    
    # Ball falls below paddle - reset
    if ball['y'] > HEIGHT:
        ball['x'] = 400
        ball['y'] = 300
        ball['vy'] = abs(ball['vy'])
        score = max(0, score - 50)
    
    # Paddle movement
    if keyboard.left and paddle['x'] > 0:
        paddle['x'] -= paddle['speed']
    if keyboard.right and paddle['x'] < WIDTH - paddle['width']:
        paddle['x'] += paddle['speed']

print("Game initialized! Use arrow keys to control the paddle.")
print("Keep the ball from falling below the paddle to score points!")
`);
        }

        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabButtons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    btn.classList.add('active');
                    const tabId = btn.dataset.tab + '-tab';
                    document.getElementById(tabId).classList.add('active');
                    
                    // Refresh editors
                    setTimeout(() => {
                        if (pythonEditor) pythonEditor.refresh();
                        if (pygameEditor) pygameEditor.refresh();
                    }, 10);
                });
            });
        }

        function initializeResizers() {
            setupResizer('pythonResizer', 'pythonConsole');
            setupResizer('pygameResizer', 'pygameConsole');
        }

        function setupResizer(resizerId, consoleId) {
            const resizer = document.getElementById(resizerId);
            const consoleSection = document.getElementById(consoleId);
            let startY, startHeight;

            resizer.addEventListener('mousedown', (e) => {
                startY = e.clientY;
                startHeight = consoleSection.offsetHeight;
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });

            function resize(e) {
                const delta = startY - e.clientY;
                consoleSection.style.height = Math.max(100, Math.min(400, startHeight + delta)) + 'px';
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        async function loadPyodide() {
            const progressBar = document.getElementById('loadingProgress');
            const loadingText = document.getElementById('loadingText');
            
            try {
                loadingText.textContent = 'Loading Python runtime...';
                progressBar.style.width = '20%';
                
                pyodide = await loadPyodide({
                    indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/'
                });
                
                progressBar.style.width = '50%';
                loadingText.textContent = 'Installing packages...';
                
                // Install commonly used packages
                await pyodide.loadPackage(['numpy', 'micropip']);
                
                progressBar.style.width = '80%';
                loadingText.textContent = 'Finalizing setup...';
                
                // Setup stdout/stderr capture
                pyodide.runPython(`
import sys
from io import StringIO

class OutputCapture:
    def __init__(self):
        self.outputs = []
    
    def write(self, text):
        if text.strip():
            self.outputs.append(text)
    
    def flush(self):
        pass
    
    def get_output(self):
        result = ''.join(self.outputs)
        self.outputs = []
        return result

output_capture = OutputCapture()
sys.stdout = output_capture
sys.stderr = output_capture
                `);
                
                progressBar.style.width = '100%';
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    document.getElementById('pythonStatus').classList.add('ready');
                    document.getElementById('pythonStatusText').textContent = 'Python Ready';
                }, 500);
                
            } catch (error) {
                console.error('Failed to load Pyodide:', error);
                loadingText.textContent = 'Error loading Python. Please refresh the page.';
            }
        }

        // ========== Python Execution ==========
        async function runPythonCode() {
            if (!pyodide) {
                appendToConsole('pythonOutput', 'Python is still loading. Please wait...', 'warning');
                return;
            }

            const code = pythonEditor.getValue();
            clearConsole();
            appendToConsole('pythonOutput', '‚ñ∂ Running Python code...', 'info');

            try {
                // Clear previous output
                pyodide.runPython('output_capture.outputs = []');
                
                // Run the code
                const result = await pyodide.runPythonAsync(code);
                
                // Get captured output
                const output = pyodide.runPython('output_capture.get_output()');
                
                if (output) {
                    output.split('\n').forEach(line => {
                        if (line.trim()) {
                            appendToConsole('pythonOutput', line, '');
                        }
                    });
                }
                
                if (result !== undefined && result !== null) {
                    appendToConsole('pythonOutput', `‚Üí ${result}`, 'success');
                }
                
                appendToConsole('pythonOutput', '‚úì Execution completed', 'success');
                
            } catch (error) {
                appendToConsole('pythonOutput', `‚úó Error: ${error.message}`, 'error');
            }
        }

        // ========== Pygame Zero Execution ==========
        async function runPygameCode() {
            if (!pyodide) {
                appendToConsole('pygameOutput', 'Python is still loading. Please wait...', 'warning');
                return;
            }

            const code = pygameEditor.getValue();
            clearPygameConsole();
            appendToConsole('pygameOutput', '‚ñ∂ Running Pygame Zero code...', 'info');

            try {
                // Clear previous output
                pyodide.runPython('output_capture.outputs = []');
                
                // Run the code (simulated - actual pygame would need additional setup)
                const result = await pyodide.runPythonAsync(code);
                
                // Get captured output
                const output = pyodide.runPython('output_capture.get_output()');
                
                if (output) {
                    output.split('\n').forEach(line => {
                        if (line.trim()) {
                            appendToConsole('pygameOutput', line, '');
                        }
                    });
                }
                
                appendToConsole('pygameOutput', '‚úì Code validated successfully', 'success');
                appendToConsole('pygameOutput', '‚Ñπ Note: Full Pygame rendering requires a desktop environment.', 'info');
                appendToConsole('pygameOutput', 'The code structure and logic have been verified.', 'info');
                
            } catch (error) {
                appendToConsole('pygameOutput', `‚úó Error: ${error.message}`, 'error');
            }
        }

        function stopGame() {
            gameRunning = false;
            document.getElementById('stopGameBtn').style.display = 'none';
            appendToConsole('pygameOutput', '‚èπ Game stopped', 'warning');
        }

        // ========== Console Functions ==========
        function appendToConsole(consoleId, message, type) {
            const console = document.getElementById(consoleId);
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = message;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            const output = document.getElementById('pythonOutput');
            output.innerHTML = '';
        }

        function clearPygameConsole() {
            const output = document.getElementById('pygameOutput');
            output.innerHTML = '';
        }

        // ========== File Management ==========
        function handleFileImport(event) {
            const files = event.target.files;
            processFiles(files);
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            processFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');
        }

        function processFiles(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    importedFiles[file.name] = {
                        data: e.target.result,
                        type: file.type
                    };
                    updateFileList();
                    appendToConsole('pygameOutput', `üìÅ Imported: ${file.name}`, 'success');
                };
                reader.readAsDataURL(file);
            });
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            Object.keys(importedFiles).forEach(filename => {
                const item = document.createElement('div');
                item.className = 'file-item';
                
                const icon = importedFiles[filename].type.startsWith('image') ? 'üñºÔ∏è' : 'üîä';
                item.innerHTML = `
                    <span>${icon}</span>
                    <span>${filename}</span>
                    <span class="file-item-remove" onclick="removeFile('${filename}')">‚úï</span>
                `;
                fileList.appendChild(item);
            });
        }

        function removeFile(filename) {
            delete importedFiles[filename];
            updateFileList();
            appendToConsole('pygameOutput', `üóëÔ∏è Removed: ${filename}`, 'warning');
        }

        // ========== AI Chat ==========
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input while processing
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const response = await callGeminiAPI(message);
                hideTypingIndicator();
                addChatMessage(response, 'assistant');
            } catch (error) {
                hideTypingIndicator();
                addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                console.error('Chat error:', error);
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }

        function addChatMessage(content, role) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            
            const avatar = role === 'user' ? 'You' : 'AI';
            
            // Parse markdown for assistant messages
            let formattedContent = content;
            if (role === 'assistant') {
                formattedContent = marked.parse(content);
            }
            
            messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-bubble">${formattedContent}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="chat-avatar">AI</div>
                <div class="chat-bubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function callGeminiAPI(message) {
            const systemPrompt = `You are PyStudio Pro AI Assistant, an expert programming assistant specialized in:
- Python programming (all skill levels)
- Pygame and Pygame Zero game development
- Debugging and error fixing
- Code optimization and best practices
- Algorithm design and data structures
- Software architecture

Guidelines:
- Provide clear, concise, and accurate responses
- Include code examples when helpful
- Explain concepts in an approachable way
- Format code blocks properly using markdown
- Be encouraging and supportive
- If you're unsure, acknowledge it

The user is working in an online Python IDE with Pygame Zero support.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `${systemPrompt}\n\nUser: ${message}`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,
                    }
                })
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Auto-resize chat input
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // ========== Initialize on Load ==========
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
