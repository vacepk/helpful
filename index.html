<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyStudio Pro - Python IDE</title>
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    
    <!-- Marked for Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 16px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 18px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 12px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .tab-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .status-indicator {
            margin-left: auto;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-orange);
        }

        .status-indicator.ready {
            background: var(--accent-green);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Editor Section */
        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-green);
            color: #000;
        }

        .btn-primary:hover {
            background: #46c35f;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-danger {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .editor-wrapper {
            flex: 1;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100%;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
        }

        /* Resizer */
        .resizer {
            height: 6px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            cursor: ns-resize;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: var(--accent-blue);
        }

        /* Console Section */
        .console-section {
            height: 200px;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .console-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .console-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .console-line {
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .console-line.info { color: var(--accent-blue); }
        .console-line.success { color: var(--accent-green); }
        .console-line.error { color: var(--accent-red); }
        .console-line.warning { color: var(--accent-orange); }

        /* Console Input */
        .console-input-line {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .console-input-line.active {
            display: flex;
        }

        .console-prompt {
            color: var(--accent-green);
            font-family: 'Fira Code', monospace;
            font-size: 13px;
        }

        .console-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--text-primary);
            font-family: 'Fira Code', monospace;
            font-size: 13px;
        }

        .console-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Pygame Section */
        .pygame-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .pygame-editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .pygame-canvas-panel {
            width: 420px;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .canvas-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .canvas-title {
            font-size: 13px;
            font-weight: 600;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #000;
        }

        #gameCanvas {
            background: #1a1a2e;
            border-radius: 4px;
            max-width: 100%;
            max-height: 100%;
        }

        .asset-panel {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            max-height: 150px;
            overflow-y: auto;
        }

        .asset-panel-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .asset-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .asset-drop-zone:hover, .asset-drop-zone.dragover {
            border-color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.1);
        }

        .asset-drop-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .asset-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .asset-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 11px;
        }

        .asset-item img {
            width: 20px;
            height: 20px;
            object-fit: cover;
            border-radius: 2px;
        }

        /* AI Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .chat-header-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-header-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-message {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message.assistant .chat-avatar {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        .chat-message.user .chat-avatar {
            background: var(--accent-green);
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.assistant .chat-bubble {
            background: var(--bg-secondary);
            border-bottom-left-radius: 4px;
        }

        .chat-message.user .chat-bubble {
            background: var(--accent-blue);
            color: #000;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble pre {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .chat-bubble code {
            font-family: 'Fira Code', monospace;
            font-size: 13px;
        }

        .chat-input-area {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: #79b8ff;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Initializing PyStudio Pro...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgress"></div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">Py</div>
                    <span class="logo-text">PyStudio Pro</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Editors</div>
                    <button class="tab-btn active" data-tab="python">
                        <span class="tab-icon">üêç</span>
                        Python
                        <div class="status-indicator" id="pythonStatus"></div>
                    </button>
                    <button class="tab-btn" data-tab="pygame">
                        <span class="tab-icon">üéÆ</span>
                        Pygame Zero
                    </button>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Tools</div>
                    <button class="tab-btn" data-tab="ai">
                        <span class="tab-icon">ü§ñ</span>
                        AI Assistant
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Python Tab -->
            <div class="tab-content active" id="python-tab">
                <div class="editor-section">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <span style="font-size: 13px; color: var(--text-secondary);">main.py</span>
                            <span id="pythonStatusText" style="font-size: 11px; color: var(--accent-orange); margin-left: 8px;">Loading...</span>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary" onclick="clearPythonConsole()">Clear</button>
                            <button class="btn btn-primary" onclick="runPythonCode()">‚ñ∂ Run</button>
                        </div>
                    </div>
                    <div class="editor-wrapper">
                        <textarea id="pythonEditor"></textarea>
                    </div>
                </div>
                <div class="resizer" id="pythonResizer"></div>
                <div class="console-section" id="pythonConsoleSection">
                    <div class="console-header">
                        <span class="console-title">Console Output</span>
                    </div>
                    <div class="console-output" id="pythonConsole"></div>
                    <div class="console-input-line" id="pythonInputLine">
                        <span class="console-prompt">>>></span>
                        <input type="text" class="console-input" id="pythonInput" placeholder="Type input and press Enter...">
                    </div>
                </div>
            </div>

            <!-- Pygame Zero Tab -->
            <div class="tab-content" id="pygame-tab">
                <div class="pygame-layout">
                    <div class="pygame-editor-panel">
                        <div class="toolbar">
                            <div class="toolbar-left">
                                <span style="font-size: 13px; color: var(--text-secondary);">game.py</span>
                            </div>
                            <div class="toolbar-right">
                                <button class="btn btn-secondary" onclick="stopGame()">Stop</button>
                                <button class="btn btn-primary" onclick="runPygameCode()">‚ñ∂ Run Game</button>
                            </div>
                        </div>
                        <div class="editor-wrapper">
                            <textarea id="pygameEditor"></textarea>
                        </div>
                        <div class="resizer" id="pygameResizer"></div>
                        <div class="console-section" id="pygameConsoleSection">
                            <div class="console-header">
                                <span class="console-title">Game Console</span>
                            </div>
                            <div class="console-output" id="pygameConsole"></div>
                        </div>
                    </div>
                    <div class="pygame-canvas-panel">
                        <div class="canvas-header">
                            <span class="canvas-title">Game Preview</span>
                            <span id="fpsCounter" style="font-size: 11px; color: var(--text-secondary);">FPS: 0</span>
                        </div>
                        <div class="canvas-container">
                            <canvas id="gameCanvas" width="400" height="300"></canvas>
                        </div>
                        <div class="asset-panel">
                            <div class="asset-panel-title">Assets</div>
                            <div class="asset-drop-zone" id="assetDropZone" onclick="document.getElementById('assetInput').click()">
                                <div class="asset-drop-text">Drop images here or click to upload</div>
                                <input type="file" id="assetInput" multiple accept="image/*" style="display: none;">
                            </div>
                            <div class="asset-list" id="assetList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Assistant Tab -->
            <div class="tab-content" id="ai-tab">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-header-title">AI Programming Assistant</div>
                        <div class="chat-header-subtitle">Powered by Google Gemini - Ask me anything about Python or Pygame!</div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message assistant">
                            <div class="chat-avatar">AI</div>
                            <div class="chat-bubble">
                                Hello! I'm your AI programming assistant. I can help you with:
                                <ul style="margin: 8px 0 0 16px;">
                                    <li>Writing Python code</li>
                                    <li>Debugging errors</li>
                                    <li>Pygame Zero game development</li>
                                    <li>Explaining programming concepts</li>
                                </ul>
                                How can I help you today?
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" placeholder="Ask me anything about Python..." rows="1"></textarea>
                            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ========== Global State ==========
        let pyodide = null;
        let pyodideReady = false;
        let pythonEditor, pygameEditor;
        let gameRunning = false;
        let gameLoopId = null;
        let importedAssets = {};
        let inputResolve = null;
        
        // Keyboard state for Pygame
        const keyboard = {
            left: false, right: false, up: false, down: false,
            space: false, a: false, d: false, w: false, s: false
        };

        // ========== Initialization ==========
        document.addEventListener('DOMContentLoaded', () => {
            initEditors();
            initTabs();
            initResizers();
            initAssetUpload();
            initKeyboardListeners();
            initInputHandler();
            loadPyodide();
        });

        function initEditors() {
            pythonEditor = CodeMirror.fromTextArea(document.getElementById('pythonEditor'), {
                mode: 'python',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                matchBrackets: true,
                autoCloseBrackets: true
            });

            pythonEditor.setValue(`# Python Editor - Full Python Support
# Try the interactive input() function!

def greet():
    name = input("What is your name? ")
    print(f"Hello, {name}!")
    
    age = input("How old are you? ")
    print(f"Wow, {age} years old! That's great!")

# Uncomment to try:
# greet()

# Or try some calculations
import math

numbers = [1, 2, 3, 4, 5]
print(f"Numbers: {numbers}")
print(f"Sum: {sum(numbers)}")
print(f"Average: {sum(numbers)/len(numbers)}")
print(f"Square root of 16: {math.sqrt(16)}")

# List comprehension
squares = [x**2 for x in numbers]
print(f"Squares: {squares}")
`);

            pygameEditor = CodeMirror.fromTextArea(document.getElementById('pygameEditor'), {
                mode: 'python',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                matchBrackets: true,
                autoCloseBrackets: true
            });

            pygameEditor.setValue(`# Pygame Zero - Bouncing Ball Game
# Use arrow keys to move the paddle!

WIDTH = 400
HEIGHT = 300
TITLE = "Bouncing Ball"

ball = {
    'x': 200,
    'y': 150,
    'vx': 4,
    'vy': 3,
    'radius': 12,
    'color': '#58a6ff'
}

paddle = {
    'x': 150,
    'y': 270,
    'width': 80,
    'height': 12,
    'speed': 6,
    'color': '#3fb950'
}

score = 0

def draw():
    screen.fill('#0d1117')
    
    # Draw ball
    screen.draw.filled_circle((ball['x'], ball['y']), ball['radius'], ball['color'])
    
    # Draw paddle
    screen.draw.filled_rect(
        Rect(paddle['x'], paddle['y'], paddle['width'], paddle['height']),
        paddle['color']
    )
    
    # Draw score
    screen.draw.text(f"Score: {score}", (10, 10), fontsize=24, color='white')

def update():
    global score
    
    # Move ball
    ball['x'] += ball['vx']
    ball['y'] += ball['vy']
    
    # Wall collisions
    if ball['x'] <= ball['radius'] or ball['x'] >= WIDTH - ball['radius']:
        ball['vx'] *= -1
    if ball['y'] <= ball['radius']:
        ball['vy'] *= -1
    
    # Paddle collision
    if (ball['y'] + ball['radius'] >= paddle['y'] and
        ball['x'] >= paddle['x'] and
        ball['x'] <= paddle['x'] + paddle['width']):
        ball['vy'] = -abs(ball['vy'])
        score += 10
    
    # Ball fell
    if ball['y'] > HEIGHT:
        ball['x'] = 200
        ball['y'] = 150
        score = max(0, score - 20)
    
    # Paddle movement
    if keyboard.left and paddle['x'] > 0:
        paddle['x'] -= paddle['speed']
    if keyboard.right and paddle['x'] < WIDTH - paddle['width']:
        paddle['x'] += paddle['speed']
`);
        }

        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
                    setTimeout(() => {
                        pythonEditor?.refresh();
                        pygameEditor?.refresh();
                    }, 10);
                });
            });
        }

        function initResizers() {
            setupResizer('pythonResizer', 'pythonConsoleSection');
            setupResizer('pygameResizer', 'pygameConsoleSection');
        }

        function setupResizer(resizerId, sectionId) {
            const resizer = document.getElementById(resizerId);
            const section = document.getElementById(sectionId);
            let startY, startH;

            resizer.addEventListener('mousedown', e => {
                startY = e.clientY;
                startH = section.offsetHeight;
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });

            function resize(e) {
                section.style.height = Math.max(100, Math.min(400, startH + startY - e.clientY)) + 'px';
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        function initAssetUpload() {
            const dropZone = document.getElementById('assetDropZone');
            const fileInput = document.getElementById('assetInput');

            ['dragenter', 'dragover'].forEach(e => {
                dropZone.addEventListener(e, evt => {
                    evt.preventDefault();
                    dropZone.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, evt => {
                    evt.preventDefault();
                    dropZone.classList.remove('dragover');
                });
            });

            dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
            fileInput.addEventListener('change', e => handleFiles(e.target.files));
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            importedAssets[file.name] = img;
                            updateAssetList();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function updateAssetList() {
            const list = document.getElementById('assetList');
            list.innerHTML = Object.keys(importedAssets).map(name => 
                `<div class="asset-item"><img src="${importedAssets[name].src}" alt="${name}"><span>${name}</span></div>`
            ).join('');
        }

        function initKeyboardListeners() {
            const keyMap = {
                'ArrowLeft': 'left', 'ArrowRight': 'right', 'ArrowUp': 'up', 'ArrowDown': 'down',
                ' ': 'space', 'a': 'a', 'd': 'd', 'w': 'w', 's': 's',
                'A': 'a', 'D': 'd', 'W': 'w', 'S': 's'
            };

            document.addEventListener('keydown', e => {
                if (keyMap[e.key]) {
                    keyboard[keyMap[e.key]] = true;
                    if (gameRunning) e.preventDefault();
                }
            });

            document.addEventListener('keyup', e => {
                if (keyMap[e.key]) keyboard[keyMap[e.key]] = false;
            });
        }

        function initInputHandler() {
            const inputField = document.getElementById('pythonInput');
            inputField.addEventListener('keydown', e => {
                if (e.key === 'Enter' && inputResolve) {
                    const value = inputField.value;
                    appendConsole('pythonConsole', '>>> ' + value, '');
                    inputField.value = '';
                    document.getElementById('pythonInputLine').classList.remove('active');
                    inputResolve(value);
                    inputResolve = null;
                }
            });
        }

        // ========== Pyodide Loading ==========
        async function loadPyodide() {
            updateLoading('Loading Python runtime...', 20);

            try {
                // Load Pyodide script dynamically
                await loadScript('https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js');
                updateLoading('Initializing Python...', 40);

                pyodide = await window.loadPyodide({
                    indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.4/full/'
                });

                updateLoading('Setting up environment...', 70);

                // Setup Python environment with proper input handling
                await pyodide.runPythonAsync(`
import sys
import io

class BrowserOutput:
    def __init__(self):
        self.buffer = []
    
    def write(self, text):
        if text:
            self.buffer.append(text)
    
    def flush(self):
        pass
    
    def getvalue(self):
        result = ''.join(self.buffer)
        self.buffer = []
        return result

_output = BrowserOutput()
sys.stdout = _output
sys.stderr = _output
                `);

                updateLoading('Python ready!', 100);
                pyodideReady = true;
                document.getElementById('pythonStatus').classList.add('ready');
                document.getElementById('pythonStatusText').textContent = 'Ready';
                document.getElementById('pythonStatusText').style.color = 'var(--accent-green)';

                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 400);

            } catch (error) {
                console.error('Failed to load Pyodide:', error);
                updateLoading('Python failed to load - Check console', 100);
                document.getElementById('pythonStatusText').textContent = 'Error';
                document.getElementById('pythonStatusText').style.color = 'var(--accent-red)';
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1500);
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function updateLoading(text, progress) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingProgress').style.width = progress + '%';
        }

        // ========== Console Functions ==========
        function appendConsole(id, text, type = '') {
            const console = document.getElementById(id);
            const line = document.createElement('div');
            line.className = 'console-line' + (type ? ' ' + type : '');
            line.textContent = text;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function clearPythonConsole() {
            document.getElementById('pythonConsole').innerHTML = '';
        }

        function clearPygameConsole() {
            document.getElementById('pygameConsole').innerHTML = '';
        }

        // ========== Python Execution ==========
        async function runPythonCode() {
            if (!pyodideReady) {
                appendConsole('pythonConsole', 'Python is still loading. Please wait...', 'warning');
                return;
            }

            clearPythonConsole();
            appendConsole('pythonConsole', '‚ñ∂ Running...', 'info');

            const code = pythonEditor.getValue();

            // Check if code uses input()
            if (code.includes('input(')) {
                await runPythonWithInput(code);
            } else {
                await runPythonSimple(code);
            }
        }

        async function runPythonSimple(code) {
            try {
                await pyodide.runPythonAsync('_output.buffer = []');
                await pyodide.runPythonAsync(code);
                const output = await pyodide.runPythonAsync('_output.getvalue()');
                
                if (output) {
                    output.split('\n').forEach(line => {
                        if (line) appendConsole('pythonConsole', line, '');
                    });
                }
                appendConsole('pythonConsole', '‚úì Done', 'success');
            } catch (error) {
                appendConsole('pythonConsole', '‚úó ' + error.message, 'error');
            }
        }

        async function runPythonWithInput(code) {
            // Parse and execute line by line, handling input() calls
            try {
                await pyodide.runPythonAsync('_output.buffer = []');
                
                // Wrap the code in a function that we can control
                const wrappedCode = `
import sys
from js import prompt_for_input

def _browser_input(prompt_text=""):
    if prompt_text:
        sys.stdout.write(prompt_text)
        sys.stdout.flush()
    return prompt_for_input(prompt_text)

# Replace input with our browser version
__builtins__.input = _browser_input

${code}
`;
                // Define the JavaScript function for prompting
                window.prompt_for_input = (prompt) => {
                    return new Promise(resolve => {
                        // Show the prompt in console
                        if (prompt) {
                            appendConsole('pythonConsole', prompt, '');
                        }
                        // Show input field
                        document.getElementById('pythonInputLine').classList.add('active');
                        document.getElementById('pythonInput').focus();
                        inputResolve = resolve;
                    });
                };

                // Run with async input support
                await pyodide.runPythonAsync(wrappedCode);
                
                const output = await pyodide.runPythonAsync('_output.getvalue()');
                if (output) {
                    output.split('\n').forEach(line => {
                        if (line) appendConsole('pythonConsole', line, '');
                    });
                }
                appendConsole('pythonConsole', '‚úì Done', 'success');
            } catch (error) {
                if (!error.message.includes('coroutine')) {
                    appendConsole('pythonConsole', '‚úó ' + error.message, 'error');
                }
            }
        }

        // ========== Pygame Zero Engine ==========
        function runPygameCode() {
            stopGame();
            clearPygameConsole();
            
            const code = pygameEditor.getValue();
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            // Parse game settings
            let WIDTH = 400, HEIGHT = 300;
            const widthMatch = code.match(/WIDTH\s*=\s*(\d+)/);
            const heightMatch = code.match(/HEIGHT\s*=\s*(\d+)/);
            if (widthMatch) WIDTH = parseInt(widthMatch[1]);
            if (heightMatch) HEIGHT = parseInt(heightMatch[1]);
            
            canvas.width = WIDTH;
            canvas.height = HEIGHT;

            appendConsole('pygameConsole', '‚ñ∂ Starting game...', 'info');

            try {
                // Create game context
                const gameContext = createGameContext(ctx, WIDTH, HEIGHT);
                
                // Execute the game code
                const gameFunc = new Function('screen', 'keyboard', 'Rect', 'Actor', 'console', code + `
                    return { draw: typeof draw !== 'undefined' ? draw : null, update: typeof update !== 'undefined' ? update : null };
                `);

                const gameFuncs = gameFunc(gameContext.screen, keyboard, gameContext.Rect, gameContext.Actor, {
                    log: (msg) => appendConsole('pygameConsole', String(msg), '')
                });

                gameRunning = true;
                let lastTime = performance.now();
                let frameCount = 0;
                let fpsTime = 0;

                function gameLoop(currentTime) {
                    if (!gameRunning) return;

                    const delta = currentTime - lastTime;
                    lastTime = currentTime;
                    
                    // FPS counter
                    frameCount++;
                    fpsTime += delta;
                    if (fpsTime >= 1000) {
                        document.getElementById('fpsCounter').textContent = `FPS: ${frameCount}`;
                        frameCount = 0;
                        fpsTime = 0;
                    }

                    // Update
                    if (gameFuncs.update) {
                        try { gameFuncs.update(); } catch (e) {}
                    }

                    // Draw
                    if (gameFuncs.draw) {
                        try { gameFuncs.draw(); } catch (e) {}
                    }

                    gameLoopId = requestAnimationFrame(gameLoop);
                }

                gameLoopId = requestAnimationFrame(gameLoop);
                appendConsole('pygameConsole', '‚úì Game running! Use arrow keys to play.', 'success');

            } catch (error) {
                appendConsole('pygameConsole', '‚úó Error: ' + error.message, 'error');
            }
        }

        function createGameContext(ctx, WIDTH, HEIGHT) {
            const screen = {
                fill: (color) => {
                    ctx.fillStyle = color;
                    ctx.fillRect(0, 0, WIDTH, HEIGHT);
                },
                draw: {
                    filled_circle: (pos, radius, color) => {
                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(pos[0], pos[1], radius, 0, Math.PI * 2);
                        ctx.fill();
                    },
                    circle: (pos, radius, color) => {
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(pos[0], pos[1], radius, 0, Math.PI * 2);
                        ctx.stroke();
                    },
                    filled_rect: (rect, color) => {
                        ctx.fillStyle = color;
                        if (rect instanceof Rect) {
                            ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                        } else {
                            ctx.fillRect(rect[0], rect[1], rect[2], rect[3]);
                        }
                    },
                    rect: (rect, color) => {
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        if (rect instanceof Rect) {
                            ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
                        } else {
                            ctx.strokeRect(rect[0], rect[1], rect[2], rect[3]);
                        }
                    },
                    line: (start, end, color) => {
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(start[0], start[1]);
                        ctx.lineTo(end[0], end[1]);
                        ctx.stroke();
                    },
                    text: (text, pos, options = {}) => {
                        const { fontsize = 24, color = 'white', center = false } = options;
                        ctx.fillStyle = color;
                        ctx.font = `${fontsize}px Inter, sans-serif`;
                        ctx.textAlign = center ? 'center' : 'left';
                        ctx.textBaseline = 'top';
                        ctx.fillText(text, pos[0], pos[1]);
                    }
                },
                blit: (image, pos) => {
                    if (importedAssets[image]) {
                        ctx.drawImage(importedAssets[image], pos[0], pos[1]);
                    }
                }
            };

            class Rect {
                constructor(x, y, width, height) {
                    this.x = x;
                    this.y = y;
                    this.width = width;
                    this.height = height;
                }
            }

            class Actor {
                constructor(imageName, pos = [0, 0]) {
                    this.image = imageName;
                    this.x = pos[0];
                    this.y = pos[1];
                    this._img = importedAssets[imageName];
                }

                draw() {
                    if (this._img) {
                        ctx.drawImage(this._img, this.x - this._img.width/2, this.y - this._img.height/2);
                    }
                }
            }

            return { screen, Rect, Actor };
        }

        function stopGame() {
            gameRunning = false;
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            document.getElementById('fpsCounter').textContent = 'FPS: 0';
        }

        // ========== AI Chat ==========
        const GEMINI_API_KEY = 'AIzaSyBhJNUxbHHVih8mukT79OvETExbY3_j9rM';
        let chatHistory = [];

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addChatMessage(message, 'user');

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.innerHTML = `
                <div class="chat-avatar">AI</div>
                <div class="chat-bubble">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            `;
            document.getElementById('chatMessages').appendChild(typingDiv);
            scrollChat();

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a helpful Python and Pygame programming assistant in PyStudio Pro IDE. 
                                       Be concise and provide code examples when relevant. Use markdown for formatting.
                                       
                                       User: ${message}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024
                        }
                    })
                });

                typingDiv.remove();

                if (response.ok) {
                    const data = await response.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not generate a response.';
                    addChatMessage(reply, 'assistant');
                } else {
                    addChatMessage('Sorry, there was an error connecting to the AI service.', 'assistant');
                }
            } catch (error) {
                typingDiv.remove();
                addChatMessage('Sorry, there was an error: ' + error.message, 'assistant');
            }
        }

        function addChatMessage(text, role) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            
            const avatar = role === 'user' ? 'üë§' : 'AI';
            let content = text;
            
            if (role === 'assistant') {
                // Parse markdown
                content = marked.parse(text);
            }
            
            messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-bubble">${content}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            scrollChat();
        }

        function scrollChat() {
            const messages = document.getElementById('chatMessages');
            messages.scrollTop = messages.scrollHeight;
        }

        // Chat input handlers
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // Auto-resize chat input
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            });
        });
    </script>
</body>
</html>
